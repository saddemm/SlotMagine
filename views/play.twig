{% extends 'layout.twig' %}

{% block body %}

  <body id="page-mobile" class="page-mobile">



  <header class="masthead">
    <div class="button-play">
      <button id="btn-play" class="btn btn-default btn-xl js-scroll-trigger">Jouer</button>
    </div>

    <div class="text text-title">
      <span><i id="essais">3</i> essais restants</span>
    </div>
    <div class="image-rotate">
      <img src="/images/portrait-rotate.png" alt="">
    </div>
    <div class="text text-middle">
      <span>prêt à jouer  </span>
    </div>
    <div class="text text-button">
      <span>Basculer votre téléphone afin d'effectuer un mouvement de levier </span>
    </div>

  </header>


  <!-- Modal -->
  <div class="modal fade" id="subscribes" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLabel">Avant de jouer, Inscrivez vous</h5>

        </div>
        <form class="form-horizontal" role="form">
        <div class="modal-body">

            <div class="form-group">
              <label  class="col-sm-2 control-label"
                      for="inputEmail">Email</label>
              <div class="col-sm-10">
                <input type="email" class="form-control"
                       id="inputEmail" placeholder="Email"/>
              </div>
            </div>
            <div class="form-group">
              <label class="col-sm-2 control-label"
                     for="inputTel" >Téléphone (optionnel)</label>
              <div class="col-sm-10">
                <input type="text" class="form-control"
                       id="inputTel" placeholder="Téléphone"/>
              </div>
            </div>


        </div>
        <div class="modal-footer">
          <button type="submit" id="starty" class="btn btn-primary" data-dismiss="modal" disabled="disabled">Jouer !</button>
        </div>
        </form>
      </div>
    </div>
  </div>



  </body>


  <script>



    $(function () {

      function isValidEmailAddress(emailAddress) {
        var pattern = /^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
        return pattern.test(emailAddress);
      }


      $("#subscribes").modal(
              {
                backdrop: 'static',
                keyboard: false
              }
      );

      $( "input[type='email']" ).bind('keyup change', function() {
        if (isValidEmailAddress(this.value)) {
          $("#starty").removeAttr("disabled");
        }else{
          $("#starty").attr("disabled", "disabled");
        }
      });



      var socket = io();

      socket.on('playPressed', function(essais){
        $("#essais").text(essais);

      });

      socket.on('Result', function(what){

       what ? winner() : looser();

      });

      socket.on("error",function(err){
        console.log('there is an error');
        if(err==1){
          $('body').text('Cette partie n"existe pas')
        }else if(err==2){
          $('body').text('Partie déjà en cours')
        }


      });

      $("#starty").on('click', function(){

        var email = $("#inputEmail").val();
        var telephone = $("#inputTel").val();

        console.log(email);
        customer = {email : email, telephone : telephone};
        roomObj = {room : '{{ code}}', customer : customer };


        socket.emit("joinRoom",roomObj);

      });


      window.addEventListener("deviceorientation", function(event) {
        if (Math.round(event.beta)<0 && !$('#btn-play').is(":disabled")){
          $('#btn-play').click();

        }

      }, true);


      $('#btn-play').click(function(){

         navigator.vibrate(5000);


        socket.emit('playPressed',"{{ code }}");


        var oldValue = $(this).text();
        $(this).attr("disabled", "disabled");
        $(this).text("Patientez...");


        setTimeout(function(){

          document.getElementById('btn-play').innerHTML = oldValue;
            document.getElementById('btn-play').removeAttribute('disabled');


        }, 5000)

      });


      function looser(){
        window.location = "/loose";
      }

      function winner(){
        window.location = "/win";
      }



    });
  </script>
{% endblock %}
